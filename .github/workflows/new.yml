name: Dynamic Matrix Workflow

on:
  push:
    branches:
      - main
      - ci/test-automation

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      dynamic-matrix: ${{ steps.convert-to-json.outputs.matrix }}
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Convert YAML to JSON
      id: convert-to-json
      run: |
        json_output=$(yq eval -o=json ./github/data/regions.yaml)
        echo "JSON output: $json_output"
        echo "matrix=$json_output" >> $GITHUB_OUTPUT

  run-instances:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region_service: ${{ fromJSON(needs.prepare-matrix.outputs.dynamic-matrix) }}

    steps:
    - name: Display matrix values
      run: |
        echo "Running for service: ${{ matrix.region_service }}"
